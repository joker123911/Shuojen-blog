<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>高精度互動式投資報酬試算表</title>
<style>
    /* 樣式與前一版相同 */
    body {
        font-family: 'Helvetica Neue', Arial, 'Heiti TC', 'Microsoft JhengHei', sans-serif;
        background-color: #f4f7f9;
        color: #333;
        display: flex;
        justify-content: center;
        padding: 20px;
    }
    .calculator-container {
        width: 100%;
        max-width: 600px;
        background-color: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h2 {
        text-align: center;
        color: #0056b3;
        margin-bottom: 20px;
    }
    .input-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .input-field {
        display: flex;
        flex-direction: column;
    }
    .input-field label {
        margin-bottom: 5px;
        color: #555;
        font-size: 14px;
    }
    .input-field input {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }
    .input-field input:focus {
        outline: none;
        border-color: #0056b3;
    }
    .unit-info {
        font-size: 13px;
        color: #666;
        text-align: right;
        margin-bottom: 20px;
    }
    .calculate-btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .calculate-btn:hover {
        background-color: #0056b3;
    }
    .results-table {
        margin-top: 25px;
        width: 100%;
        border-collapse: collapse;
    }
    .results-table th, .results-table td {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: center;
        vertical-align: middle;
    }
    .results-table th {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        padding: 10px;
    }
    .results-table input {
        width: 90%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
        -moz-appearance: textfield;
    }
    .results-table input::-webkit-outer-spin-button,
    .results-table input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .results-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    #error-message {
        color: red;
        text-align: center;
        margin-top: 15px;
        display: none;
    }
</style>
</head>
<body>

<div class="calculator-container">
    <h2>複利試算表</h2>

    <div class="input-group">
        <div class="input-field">
            <label for="startAge">起始年齡</label>
            <input type="number" id="startAge" value="27">
        </div>
        <div class="input-field">
            <label for="endAge">結束年齡</label>
            <input type="number" id="endAge" value="67">
        </div>
        <div class="input-field">
            <label for="annualSavings">每年存入金額</label>
            <input type="number" id="annualSavings" value="12">
        </div>
        <div class="input-field">
            <label for="rateOfReturn">年報酬率 (%)</label>
            <input type="number" id="rateOfReturn" value="5">
        </div>
    </div>
    <div class="unit-info">金額單位：萬元</div>

    <button class="calculate-btn" onclick="generateInitialTable()">產生/重設表格</button>
    <p id="error-message"></p>

    <table class="results-table">
        <thead>
            <tr>
                <th>年齡</th>
                <th>年存金額</th>
                <th>當年度報酬</th>
                <th>累計總金額</th>
            </tr>
        </thead>
        <tbody id="results-body">
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', generateInitialTable);

    function generateInitialTable() {
        const startAge = parseInt(document.getElementById('startAge').value);
        const endAge = parseInt(document.getElementById('endAge').value);
        const annualSavings = parseFloat(document.getElementById('annualSavings').value);
        const resultsBody = document.getElementById('results-body');
        const errorMessage = document.getElementById('error-message');
        resultsBody.innerHTML = '';
        errorMessage.style.display = 'none';

        if (isNaN(startAge) || isNaN(endAge) || isNaN(annualSavings) || startAge >= endAge) {
            errorMessage.textContent = '請輸入有效的數字，且起始年齡必須小於結束年齡。';
            errorMessage.style.display = 'block';
            return;
        }

        for (let age = startAge; age <= endAge; age++) {
            const row = document.createElement('tr');
            // 我們在累計總金額的 input 中新增了一個 'data-full-value' 屬性
            row.innerHTML = `
                <td>${age}</td>
                <td><input type="number" id="savings-${age}" value="${annualSavings.toFixed(1)}" step="0.1" onchange="handleSavingsChange(${age})"></td>
                <td id="return-${age}">0.0</td>
                <td><input type="number" id="total-${age}" value="0.0" data-full-value="0.0" step="0.1" onchange="handleTotalChange(${age})"></td>
            `;
            resultsBody.appendChild(row);
        }
        updateFromRow(startAge);
    }

    function handleSavingsChange(age) {
        updateFromRow(age);
    }

    function handleTotalChange(age) {
        const endAge = parseInt(document.getElementById('endAge').value);

        // **ADDED**: 當手動修改總額時，同步更新背後儲存的精確值
        const changedTotalInput = document.getElementById(`total-${age}`);
        changedTotalInput.dataset.fullValue = parseFloat(changedTotalInput.value);

        if (age < endAge) {
            updateFromRow(age + 1);
        }
    }

    function updateFromRow(startUpdateAge) {
        const startAge = parseInt(document.getElementById('startAge').value);
        const endAge = parseInt(document.getElementById('endAge').value);
        const rateOfReturn = parseFloat(document.getElementById('rateOfReturn').value) / 100;

        for (let age = startUpdateAge; age <= endAge; age++) {
            // **CHANGED**: 優先讀取 'data-full-value' 的精確值來計算
            const prevTotalElement = document.getElementById(`total-${age - 1}`);
            const previousTotal = (age === startAge) ? 0 : parseFloat(prevTotalElement.dataset.fullValue || prevTotalElement.value);

            const currentSavings = parseFloat(document.getElementById(`savings-${age}`).value);

            // 計算過程完全使用浮點數，不進行四捨五入
            const currentReturn = previousTotal * rateOfReturn;
            const newTotal = previousTotal + currentReturn + currentSavings;

            // **CHANGED**: 分別更新「顯示值」和「精確值」
            const totalInput = document.getElementById(`total-${age}`);
            document.getElementById(`return-${age}`).textContent = currentReturn.toFixed(1); // 報酬只用於顯示，所以直接四捨五入

            totalInput.value = newTotal.toFixed(1); // 更新顯示用的值 (小數點後一位)
            totalInput.dataset.fullValue = newTotal.toFixed(5); // 更新計算用的值 (小數點後五位)
        }
    }
</script>

</body>
</html>